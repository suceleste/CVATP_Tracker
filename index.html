<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portefeuille CVATP</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@800&display=swap" rel="stylesheet">
<style>
:root{--bg:#09090b;--sur:#111114;--sur2:#17171b;--bdr:#1f1f25;--bdrl:#2a2a32;--tx:#e4e4e7;--txm:#52525b;--txd:#71717a;--g:#22c55e;--gbg:rgba(34,197,94,.08);--r:#ef4444;--rbg:rgba(239,68,68,.08);--ac:#6366f1;--acg:rgba(99,102,241,.12)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Mono',monospace;background:var(--bg);color:var(--tx);font-size:12.5px}
.hd{padding:14px 20px;border-bottom:1px solid var(--bdr);background:var(--sur)}
.hd-tag{font-size:9px;letter-spacing:.16em;text-transform:uppercase;color:var(--txm);margin-bottom:2px}
.hd-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--tx)}
.tb{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;border-bottom:1px solid var(--bdr);background:var(--sur);gap:8px;flex-wrap:wrap}
.si{position:relative}
.si svg{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--txm);pointer-events:none}
.si input{background:var(--bg);border:1px solid var(--bdrl);border-radius:4px;padding:5px 10px 5px 26px;color:var(--tx);font-family:'DM Mono',monospace;font-size:11px;width:190px;outline:none}
.si input:focus{border-color:var(--ac)}
.si input::placeholder{color:var(--txm)}
.fg{display:flex;gap:4px;flex-wrap:wrap}
.fb{padding:4px 10px;border-radius:4px;border:1px solid var(--bdrl);background:transparent;color:var(--txd);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;transition:all .15s}
.fb:hover{border-color:var(--ac);color:var(--ac)}
.fb.on{background:var(--acg);border-color:var(--ac);color:var(--ac)}
.tw{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:800px}
thead tr{border-bottom:1px solid var(--bdrl)}
th{padding:9px 12px;font-size:9.5px;font-weight:500;letter-spacing:.12em;text-transform:uppercase;color:var(--txm);text-align:left;white-space:nowrap;cursor:pointer;user-select:none;position:sticky;top:0;background:var(--sur);z-index:1;transition:color .15s}
th:hover{color:var(--txd)}
th.on{color:var(--ac)}
.r{text-align:right}
tbody tr{border-bottom:1px solid var(--bdr);transition:background .1s;animation:fr .2s ease both}
tbody tr:hover{background:var(--sur2)}
tbody tr.cl{opacity:.45}
tbody tr.cl:hover{opacity:.7;background:var(--sur2)}
@keyframes fr{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
td{padding:10px 12px;font-size:12px;white-space:nowrap}
.vn{font-weight:500;max-width:210px;overflow:hidden;text-overflow:ellipsis}
.vt{font-size:10px;color:var(--txm);margin-top:1px}
.pc{font-weight:500}
.cu{font-size:10px;color:var(--txm);margin-left:2px}
.dv{color:var(--txd);font-size:11px}
.pb{display:inline-flex;align-items:center;gap:3px;padding:3px 8px;border-radius:3px;font-size:11.5px;font-weight:500}
.pb.up{background:var(--gbg);color:var(--g)}
.pb.dn{background:var(--rbg);color:var(--r)}
.pb.fl{background:var(--sur2);color:var(--txd)}
.sp{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px}
.sp.op{background:var(--gbg);color:var(--g)}
.sp.cl2{background:var(--sur2);color:var(--txd);border:1px solid var(--bdrl)}
.ft{padding:8px 16px;border-top:1px solid var(--bdr);display:flex;justify-content:space-between;font-size:10px;color:var(--txm);background:var(--sur)}
.em{text-align:center;padding:40px;color:var(--txm);font-size:12px}
.err{margin:10px 16px;padding:10px 14px;border-radius:4px;background:var(--rbg);border:1px solid rgba(239,68,68,.22);color:var(--r);font-size:11px;display:none}
</style>
</head>
<body>

<div class="hd">
  <div class="hd-tag">Portefeuille ¬∑ CVATP</div>
  <div class="hd-name" id="hdName">Chargement‚Ä¶</div>
</div>

<div class="tb">
  <div class="si">
    <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input id="q" placeholder="Rechercher‚Ä¶" oninput="render()">
  </div>
  <div class="fg">
    <button class="fb on" onclick="fil('all',this)">Toutes</button>
    <button class="fb" onclick="fil('open',this)">Ouvertes</button>
    <button class="fb" onclick="fil('closed',this)">Cl√¥tur√©es</button>
    <button class="fb" onclick="fil('pos',this)">‚ñ≤ Positives</button>
    <button class="fb" onclick="fil('neg',this)">‚ñº N√©gatives</button>
  </div>
</div>

<div class="err" id="err"></div>

<div class="tw">
  <table>
    <thead><tr>
      <th onclick="srt('valeur',this)">Valeur</th>
      <th onclick="srt('pays',this)">Pays</th>
      <th class="r" onclick="srt('achatCours',this)">Achat</th>
      <th class="r" onclick="srt('achatDate',this)">Date achat</th>
      <th class="r" onclick="srt('venteCours',this)">Vente</th>
      <th class="r" onclick="srt('venteDate',this)">Date vente</th>
      <th class="r" onclick="srt('dernierCours',this)">Dernier cours</th>
      <th class="r" onclick="srt('perf',this)">Perf. %</th>
      <th>Statut</th>
    </tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="ft">
  <span>Cotation Google Finance ¬∑ CVATP</span>
  <span id="cnt"></span>
</div>

<script>
// ‚îÄ‚îÄ URL du CSV dans le repo GitHub ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CSV_URL = 'https://raw.githubusercontent.com/suceleste/CVATP_Tracker/main/data.csv';

// ‚îÄ‚îÄ Filtre g√©rant via ?gerant=Alain+Pitous dans l'URL de l'iframe ‚îÄ‚îÄ‚îÄ
const GERANT = new URLSearchParams(location.search).get('gerant') || '';

const FLAGS = {US:'üá∫üá∏',FR:'üá´üá∑',GB:'üá¨üáß',DK:'üá©üá∞',DE:'üá©üá™'};
let DATA=[], filt='all', sk=null, sa=true;

// ‚îÄ‚îÄ CHARGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
fetch(CSV_URL)
  .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.text(); })
  .then(csv => {
    const rows = csv.trim().split('\n').map(l => l.split(',').map(c => c.trim()));
    const h    = rows[0].map(c => c.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,''));
    const ci   = (...ns) => { for(const n of ns){ const i=h.findIndex(c=>c.includes(n)); if(i>=0)return i; } return -1; };

    const I = {
      valeur: ci('valeur','nom','libelle'),
      pays:   ci('pays'),
      gerant: ci('gerant','manager'),
      ac:     ci('achatcours'),
      ad:     ci('achatdate'),
      vc:     ci('ventecours'),
      vd:     ci('ventedate'),
      ticker: ci('ticker'),
      dc:     ci('derniercours','dernier'),
      perf:   ci('perf'),
      devise: ci('devise','currency'),
    };

    const s = (r,i) => i>=0 && r[i] ? r[i].replace(/^"|"$/g,'').trim() : '';
    const n = (r,i) => { if(i<0||!r[i]) return null; const v=parseFloat(r[i].replace(',','.')); return isNaN(v)?null:v; };

    let parsed = rows.slice(1).filter(r=>r.join('').trim() && s(r,I.valeur)).map(r => {
      const ac=n(r,I.ac), vc=n(r,I.vc), dc=n(r,I.dc);
      let perf=n(r,I.perf);
      if(perf==null){ const ref=vc||dc; if(ref&&ac) perf=Math.round((ref-ac)/ac*10000)/100; }
      const ticker=s(r,I.ticker);
      let devise=s(r,I.devise);
      if(!devise){ if(/^(EPA|ETR|AMS):/.test(ticker)) devise='EUR'; else if(/^LON:/.test(ticker)) devise='GBX'; else if(/^CPH:/.test(ticker)) devise='DKK'; else devise='USD'; }
      return { valeur:s(r,I.valeur).split('(')[0].trim(), ticker, pays:s(r,I.pays), gerant:s(r,I.gerant), achatCours:ac, achatDate:s(r,I.ad), venteCours:vc, venteDate:s(r,I.vd), dernierCours:dc, perf, devise };
    });

    if(GERANT) parsed = parsed.filter(r => r.gerant.toLowerCase()===GERANT.toLowerCase());
    if(!parsed.length){ showErr(GERANT ? `Aucune position pour "${GERANT}".` : 'Fichier vide.'); return; }

    DATA = parsed;
    document.getElementById('hdName').textContent = GERANT || (parsed.find(r=>r.gerant)?.gerant) || 'Portefeuille';
    render();
  })
  .catch(e => showErr('Impossible de charger le CSV : ' + e.message));

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getRows(){
  const q=(document.getElementById('q').value||'').toLowerCase();
  let r=[...DATA];
  if(filt==='open')   r=r.filter(x=>!x.venteDate);
  if(filt==='closed') r=r.filter(x=> x.venteDate);
  if(filt==='pos')    r=r.filter(x=>(x.perf??0)>0);
  if(filt==='neg')    r=r.filter(x=>(x.perf??0)<0);
  if(q) r=r.filter(x=>x.valeur.toLowerCase().includes(q)||x.ticker.toLowerCase().includes(q)||x.pays.toLowerCase().includes(q));
  if(sk) r.sort((a,b)=>{
    let va=a[sk]??-Infinity, vb=b[sk]??-Infinity;
    if(typeof va==='string')return sa?va.localeCompare(vb,'fr'):vb.localeCompare(va,'fr');
    return sa?va-vb:vb-va;
  });
  return r;
}

function render(){
  const list=getRows();
  document.getElementById('cnt').textContent=list.length+' position'+(list.length>1?'s':'');
  if(!list.length){ document.getElementById('tbody').innerHTML=`<tr><td colspan="9" class="em">Aucune position.</td></tr>`; return; }
  document.getElementById('tbody').innerHTML=list.map((r,i)=>{
    const open=!r.venteDate, fl=FLAGS[r.pays]||'', p=r.perf;
    const ph=p!=null?`<span class="pb ${p>0?'up':p<0?'dn':'fl'}">${p>=0?'‚ñ≤':'‚ñº'} ${fm(Math.abs(p))} %</span>`:'<span style="color:var(--txm)">‚Äî</span>';
    const pr=v=>v!=null?`<span class="pc">${fm(v)}</span>`:'‚Äî';
    return `<tr class="${open?'':'cl'}" style="animation-delay:${i*10}ms">
      <td><div class="vn">${fl} ${e(r.valeur)}</div><div class="vt">${e(r.ticker)}</div></td>
      <td>${fl} ${e(r.pays)}</td>
      <td class="r">${r.achatCours!=null?`${pr(r.achatCours)}<span class="cu">${r.devise}</span>`:'‚Äî'}</td>
      <td class="r dv">${e(r.achatDate)||'‚Äî'}</td>
      <td class="r">${r.venteCours!=null?`${pr(r.venteCours)}<span class="cu">${r.devise}</span>`:'‚Äî'}</td>
      <td class="r dv">${e(r.venteDate)||'‚Äî'}</td>
      <td class="r">${r.dernierCours!=null?`${pr(r.dernierCours)}<span class="cu">${r.devise}</span>`:'‚Äî'}</td>
      <td class="r">${ph}</td>
      <td><span class="sp ${open?'op':'cl2'}">${open?'‚óè Ouverte':'Cl√¥tur√©e'}</span></td>
    </tr>`;
  }).join('');
}

function fil(f,btn){filt=f;document.querySelectorAll('.fb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');render();}
function srt(k,th){sa=sk===k?!sa:true;sk=k;document.querySelectorAll('th').forEach(t=>t.classList.remove('on'));th.classList.add('on');render();}
function fm(n){return n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function e(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function showErr(m){const el=document.getElementById('err');el.textContent='‚ö† '+m;el.style.display='block';document.getElementById('hdName').textContent='Erreur';}
</script>
</body>
</html>
